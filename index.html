<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<title>Ben's Sugarcane Squeezer</title>
<style>
html, body, #canvas { margin:0; padding:0; border:0; }
body { color:white; background:black; overflow:hidden; touch-action:none; }
#canvas { display:block; }
#canvas:focus { outline:none; }
#status, #status-splash, #status-progress { position:absolute; left:0; right:0; }
#status, #status-splash { top:0; bottom:0; }
#status { background-color:#ffff00; display:flex; flex-direction:column; justify-content:center; align-items:center; visibility:hidden; }
#status-splash { max-height:100%; max-width:100%; margin:auto; }
#status-splash.show-image--false { display:none; }
#status-splash.fullsize--true { height:100%; width:100%; object-fit:contain; }
#status-splash.use-filter--false { image-rendering:pixelated; }
#status-progress, #status-notice { display:none; }
#status-progress { bottom:10%; width:50%; margin:0 auto; }
#status-notice { background-color:#5b3943; border-radius:.5rem; border:1px solid #9b3943; color:#e0e0e0; font-family:'Noto Sans', 'Droid Sans', Arial, sans-serif; line-height:1.3; margin:0 2rem; overflow:hidden; padding:1rem; text-align:center; z-index:1; }
</style>
<link rel="icon" href="Bens_Sugarcane_Squeezer.icon.png" />
<link rel="apple-touch-icon" href="Bens_Sugarcane_Squeezer.apple-touch-icon.png"/>
</head>
<body>
<canvas id="canvas">Your browser does not support the canvas tag.</canvas>

<div id="status">
  <img id="status-splash" class="show-image--true fullsize--false use-filter--true" src="Bens_Sugarcane_Squeezer.png" alt="">
  <progress id="status-progress"></progress>
  <div id="status-notice"></div>
</div>

<script src="Bens_Sugarcane_Squeezer.js"></script>
<script>
const GODOT_CONFIG = {
    args: [],
    canvasResizePolicy: 2,
    ensureCrossOriginIsolationHeaders: true,
    executable: "Bens_Sugarcane_Squeezer",
    experimentalVK: false,
    fileSizes: {
        "Bens_Sugarcane_Squeezer.pck": 5338192,
        "Bens_Sugarcane_Squeezer.wasm": 43699190
    },
    focusCanvas: true,
    gdextensionLibs: []
};

const GODOT_THREADS_ENABLED = false;

const wasmChunks = [
    "Bens_Sugarcane_Squeezer.wasm.part1",
    "Bens_Sugarcane_Squeezer.wasm.part2"
];

// Helper to concatenate Uint8Arrays
function concatUint8Arrays(arrays) {
    let totalLength = arrays.reduce((sum, arr) => sum + arr.length, 0);
    let result = new Uint8Array(totalLength);
    let offset = 0;
    for (let arr of arrays) {
        result.set(arr, offset);
        offset += arr.length;
    }
    return result;
}

// Fetch and merge WASM chunks with progress
async function fetchWasmChunks(chunks) {
    const buffers = [];
    for (const url of chunks) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to load ${url}`);
        const reader = res.body.getReader();
        const contentLength = +res.headers.get('Content-Length') || 0;
        let receivedLength = 0;
        const chunksArray = [];
        while(true) {
            const {done, value} = await reader.read();
            if (done) break;
            chunksArray.push(value);
            receivedLength += value.length;
            // Update progress
            statusProgress.value = contentLength ? receivedLength : 0;
            statusProgress.max = contentLength ? contentLength : 1;
            statusNotice.textContent = `Loading ${url}: ${contentLength ? Math.floor((receivedLength/contentLength)*100) : '?'}%`;
        }
        buffers.push(concatUint8Arrays(chunksArray));
    }
    // merge all chunk buffers
    let totalLength = buffers.reduce((sum, buf) => sum + buf.byteLength, 0);
    let merged = new Uint8Array(totalLength);
    let offset = 0;
    for (const buf of buffers) {
        merged.set(new Uint8Array(buf), offset);
        offset += buf.byteLength;
    }
    return merged.buffer;
}

// Start the engine
(async () => {
    const statusOverlay = document.getElementById('status');
    const statusProgress = document.getElementById('status-progress');
    const statusNotice = document.getElementById('status-notice');

    function setStatusMode(mode) {
        if (mode === 'hidden') {
            statusOverlay.remove();
            return;
        }
        statusOverlay.style.visibility = 'visible';
        statusProgress.style.display = mode === 'progress' ? 'block' : 'none';
        statusNotice.style.display = mode === 'notice' ? 'block' : 'none';
    }

    function setStatusNotice(text) {
        statusNotice.textContent = text;
    }

    try {
        setStatusMode('progress');
        const wasmBuffer = await fetchWasmChunks(wasmChunks);
        GODOT_CONFIG.wasmBinary = wasmBuffer;
        const engine = new Engine(GODOT_CONFIG);
        engine.startGame({
            onProgress: (current, total) => {
                if (current > 0 && total > 0) {
                    statusProgress.value = current;
                    statusProgress.max = total;
                    statusNotice.textContent = `Loading engine: ${Math.floor((current/total)*100)}%`;
                } else {
                    statusProgress.removeAttribute('value');
                    statusProgress.removeAttribute('max');
                }
            }
        }).then(() => {
            setStatusMode('hidden');
        }).catch(err => {
            console.error(err);
            setStatusNotice(err.message || "Failed to start the game.");
            setStatusMode('notice');
        });
    } catch (err) {
        console.error(err);
        setStatusNotice(err.message || "Failed to load WASM chunks.");
        setStatusMode('notice');
    }
})();
</script>
</body>
</html>
